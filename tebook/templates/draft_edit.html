{% extends "layout.html" %}

{% block title %}{{ action }} чернетку - TeBook{% endblock %}

{% block content %}
<h1>{{ action }} чернетку</h1>

<form method="post" action="{% if draft %}/drafts/{{ draft.id }}{% else %}/drafts/{% endif %}">
    <label for="title">
        Назва
        <input type="text" id="title" name="title" value="{% if draft %}{{ draft.title }}{% endif %}" required>
    </label>
    
    <label for="language">
        Мова програмування
        <select id="language" name="language">
            <option value="python" {% if draft and draft.language == 'python' %}selected{% endif %}>Python</option>
            <option value="javascript" {% if draft and draft.language == 'javascript' %}selected{% endif %}>JavaScript</option>
            <option value="java" {% if draft and draft.language == 'java' %}selected{% endif %}>Java</option>
            <option value="cpp" {% if draft and draft.language == 'cpp' %}selected{% endif %}>C++</option>
            <option value="csharp" {% if draft and draft.language == 'csharp' %}selected{% endif %}>C#</option>
        </select>
    </label>
    
    <fieldset>
        <legend>Типи документів <span class="required-marker">*</span></legend>
        <label>
            <input type="checkbox" name="doc_types" value="html-stu" {% if draft and draft.doc_type == 'html-stu' %}checked{% endif %}>
            HTML (студентський)
        </label>
        <label>
            <input type="checkbox" name="doc_types" value="html-tut" {% if draft and draft.doc_type == 'html-tut' %}checked{% endif %}>
            HTML (викладацький)
        </label>
        <label>
            <input type="checkbox" name="doc_types" value="md" {% if draft and draft.doc_type == 'md' %}checked{% endif %}>
            Markdown
        </label>
        <small>Оберіть хоча б один формат. Можна вибрати кілька форматів - для кожного буде створена окрема чернетка.</small>
        <details class="details-margin">
            <summary>Опис типів документів</summary>
            <ul>
                <li><strong>HTML студентський</strong> - спрощений формат для студентів, мінімальне форматування, прості кольори та стилі, базові можливості відображення, призначений для швидкого перегляду.</li>
                <li><strong>HTML викладацький</strong> - розширений формат для викладачів, градієнтні фони та тіні, покращена типографіка, анімації та ефекти наведення, професійне оформлення, додаткові візуальні ефекти.</li>
                <li><strong>Markdown</strong> - текстовий формат для експорту та подальшої обробки, зручний для конвертації в інші формати.</li>
            </ul>
        </details>
    </fieldset>
    
    <fieldset>
        <legend>Режими презентації</legend>
        {% set view_modes_list = (draft.view_modes.split(',') if draft and draft.view_modes else ['slides', 'document', 'full-document']) %}
        <label>
            <input type="checkbox" name="view_modes" value="slides" {% if 'slides' in view_modes_list %}checked{% endif %}>
            Слайди (з навігацією)
        </label>
        <label>
            <input type="checkbox" name="view_modes" value="document" {% if 'document' in view_modes_list %}checked{% endif %}>
            Документ (з'являються по кліку)
        </label>
        <label>
            <input type="checkbox" name="view_modes" value="full-document" {% if 'full-document' in view_modes_list %}checked{% endif %}>
            Документ (повний)
        </label>
        <small>Оберіть режими презентації, які будуть доступні для перегляду</small>
    </fieldset>
    
    <label for="content">
        Вміст чернетки
        <textarea id="content" name="content" required>{% if draft %}{{ draft.content }}{% endif %}</textarea>
        <details class="details-margin">
            <summary>Використовуйте маркери @1-@7 для позначення типів слайдів. Рядки з @@ - коментарі.</summary>
            <ul>
                <li><strong>@1</strong> - Заголовок презентації або її частини</li>
                <li><strong>@2</strong> - Підзаголовок</li>
                <li><strong>@3</strong> - Основний текст (підтримує стилі)</li>
                <li><strong>@4</strong> - Визначення (в рамці)</li>
                <li><strong>@5</strong> - Багаторядковий фрагмент програмного коду</li>
                <li><strong>@6</strong> - Задача</li>
                <li><strong>@7</strong> - Таблиця (CSV формат)</li>
                <li><strong>Стилі в слайді @3:</strong></li>
                <li><strong>{ { код } }</strong> - рядок програмного коду (*без пробілів)</li>
                <li><strong>{виділений}</strong> - виділений текст</li>
                <li><strong>[[посилання]]</strong> - посилання або зображення</li>
                <li><strong>Латинські слова</strong> автоматично стають курсивом</li>
            </ul>
        </details>
    </label>
    
    <div class="actions">
        <button type="submit">{{ action }}</button>
        <a href="{% if draft %}/drafts/{{ draft.id }}{% else %}/drafts/{% endif %}" role="button" class="secondary">Скасувати</a>
    </div>
</form>

<script>
    let formChanged = false;
    let initialFormState = '';
    const form = document.querySelector('form');
    const inputs = form.querySelectorAll('input, textarea, select');

    function saveInitialState() {
        const formData = new FormData(form);
        initialFormState = Array.from(formData.entries()).sort().toString();
    }

    function checkFormChanged() {
        const formData = new FormData(form);
        const currentState = Array.from(formData.entries()).sort().toString();
        return currentState !== initialFormState;
    }

    saveInitialState();
    
    // Відстеження змін у формі
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = checkFormChanged();
        });
        input.addEventListener('input', function() {
            formChanged = checkFormChanged();
        });
    });
    

    const beforeUnloadHandler = function(e) {
        if (formChanged || checkFormChanged()) {
            // Стандартний спосіб для сучасних браузерів
            e.preventDefault();
            // Для сумісності зі старими браузерами
            e.returnValue = '';
            return '';
        }
    };
    
    // Додаємо обробник тільки якщо підтримується
    if (typeof window.addEventListener !== 'undefined') {
        window.addEventListener('beforeunload', beforeUnloadHandler);
    }
    
    form.addEventListener('submit', function() {
        formChanged = false;
        window.removeEventListener('beforeunload', beforeUnloadHandler);
    });
    
    // Валідація: хоча б один формат має бути обраний
    form.addEventListener('submit', function(e) {
        const checkboxes = document.querySelectorAll('input[name="doc_types"]:checked');
        if (checkboxes.length === 0) {
            e.preventDefault();
            alert('Будь ласка, оберіть хоча б один тип документа');
            return false;
        }
    });

    const cancelButton = document.querySelector('a[role="button"].secondary');
    if (cancelButton) {
        cancelButton.addEventListener('click', function(e) {
            if (formChanged || checkFormChanged()) {
                if (!confirm('У вас є незбережені зміни. Ви впевнені, що хочете покинути сторінку?')) {
                    e.preventDefault();
                    return false;
                }
            }
            formChanged = false;
        });
    }

    // Перехоплення кліків по навігаційних посиланнях
    document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && link.href && !link.href.startsWith('javascript:') && link.getAttribute('href') !== '#') {
            // Перевіряємо, чи це не кнопка скасування (вона вже обробляється окремо)
            if (link.classList.contains('secondary') && link.getAttribute('role') === 'button') {
                return;
            }
            
            if (formChanged || checkFormChanged()) {
                if (!confirm('У вас є незбережені зміни. Ви впевнені, що хочете покинути сторінку?')) {
                    e.preventDefault();
                    return false;
                }
                formChanged = false;
            }
        }
    }, true);
</script>
{% endblock %}

